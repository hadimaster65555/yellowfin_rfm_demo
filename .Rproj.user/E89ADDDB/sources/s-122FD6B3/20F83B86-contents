# load library
library(tidyverse)
library(rfm)

# melihat data
raw_data

# menghitung revenue
raw_data %>% 
  group_by(Nama_Siswa_Tanpa_Kurung) %>% 
  summarise(total = sum(nominal_dalam_ribu)) %>% 
  ungroup() -> count_data

# mencari last_date_visit
raw_data %>% 
  select(Tanggal, Nama_Siswa_Tanpa_Kurung) %>% 
  group_by(Nama_Siswa_Tanpa_Kurung) %>% 
  slice(which.max(as.Date(Tanggal))) %>% 
  ungroup() -> recent_date_data

# menghitung recency_days
recent_date_data %>% 
  mutate(recency_days = lubridate::as_date("2019-10-19") - Tanggal) %>% 
  select(Nama_Siswa_Tanpa_Kurung, recency_days) -> recency_data

# menghitung number_of_order
raw_data %>% 
  group_by(Nama_Siswa_Tanpa_Kurung) %>% 
  count(name = "number_of_order") %>% 
  ungroup() -> number_of_order_data

# joine data
joined_data <- inner_join(x = count_data, y = recent_date_data)
  # inner_join(y = number_of_order_data) %>% 
  # inner_join(y = recency_data) %>% 
  

# analysis_date <- lubridate::as_date("2019-10-21", tz = 'UTC')
# 
# # renaming column
# joined_data %>% 
#   rename(
#     customer_id = Nama_Siswa_Tanpa_Kurung,
#     revenue = total,
#     most_recent_visit = Tanggal,
#     number_of_orders = number_of_order,
#     recency_days = recency_days
#   ) -> joined_data
# 
# # membuat RFM table
# result <- rfm_table_customer(
#   data = joined_data, 
#   customer_id = customer_id,
#   total_revenue = revenue,
#   n_transactions = number_of_orders,
#   recency_days = recency_days,
#   analysis_date = analysis_date
# )
# 
# hasil <- result$rfm
# 
# hasil <- hasil %>% 
#   as_tibble() %>% 
#   select(recency_score, frequency_score, monetary_score, rfm_score)